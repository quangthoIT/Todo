import crypto from "crypto";
import groupModel from "../models/groupModel.js";
import userModel from "../models/userModel.js";
import groupTaskModel from "../models/groupTaskModel.js";
import { sendMailJoinGroup } from "../utils/sendMailJoinGroup.js";

// ----- TẠO NHÓM -----
export const createGroup = async (req, res) => {
  try {
    const { name, description } = req.body;
    const userId = req.user._id; // ID người dùng tạo nhóm

    // Kiểm tra tên nhóm
    if (!name || name.trim().length === 0) {
      return res.status(400).json({
        success: false,
        message: "Group name is required",
      });
    }

    // Tạo nhóm mới
    const newGroup = await groupModel.create({
      name: name.trim(),
      description: description?.trim() || "",
      owner: userId,
      members: [
        {
          userId: userId,
          role: "Owner",
          joinedAt: new Date(),
        },
      ],
    });

    // Lấy thông tin đầy đủ của Owner và Members
    await newGroup.populate("owner", "userName email avatar");
    await newGroup.populate("members.userId", "userName email avatar");

    res.status(201).json({
      success: true,
      message: "Group created successfully",
      group: newGroup,
    });
  } catch (error) {
    console.error("Error creating group:", error);
    res.status(500).json({
      success: false,
      message: "Server error",
      error: error.message,
    });
  }
};

// ----- LẤY TẤT CẢ NHÓM MÀ USER ĐANG THAM GIA -----
export const getUserGroups = async (req, res) => {
  try {
    const userId = req.user._id;
    // Tìm tất cả nhóm có Members chứa userId
    const groups = await groupModel
      .find({ "members.userId": userId })
      .populate("owner", "userName email avatar")
      .populate("members.userId", "userName email avatar")
      .sort({ createdAt: -1 });

    res.status(200).json({
      success: true,
      groups,
    });
  } catch (error) {
    console.error("Error fetching groups:", error);
    res.status(500).json({
      success: false,
      message: "Server error",
      error: error.message,
    });
  }
};

// ----- LẤY CHI TIẾT MỘT NHÓM -----
export const getGroupById = async (req, res) => {
  try {
    const { groupId } = req.params;
    const userId = req.user._id;

    // Lấy thông tin nhóm kèm Owner + Members
    const group = await groupModel
      .findById(groupId)
      .populate("owner", "userName email avatar")
      .populate("members.userId", "userName email avatar");

    // Không tìm thấy nhóm
    if (!group) {
      return res.status(404).json({
        success: false,
        message: "Group not found",
      });
    }
    // Kiểm tra xem user có thuộc nhóm hay không
    const isMember = group.members.some(
      (Member) => Member.userId._id.toString() === userId.toString()
    );

    if (!isMember) {
      return res.status(403).json({
        success: false,
        message: "You are not a member of this group",
      });
    }

    res.status(200).json({
      success: true,
      group,
    });
  } catch (error) {
    console.error("Error fetching group:", error);
    res.status(500).json({
      success: false,
      message: "Server error",
      error: error.message,
    });
  }
};

// ----- CẬP NHẬT THÔNG TIN NHÓM -----
export const updateGroup = async (req, res) => {
  try {
    const { groupId } = req.params;
    const { name, description } = req.body;
    const userId = req.user._id;

    // Lấy thông tin nhóm
    const group = await groupModel.findById(groupId);

    if (!group) {
      return res.status(404).json({
        success: false,
        message: "Group not found",
      });
    }

    // Kiểm tra quyền owner
    if (group.owner.toString() !== userId.toString()) {
      return res.status(403).json({
        success: false,
        message: "Only group owner can update group details",
      });
    }

    // Cập nhật dữ liệu nếu có truyền lên
    if (name) group.name = name.trim();
    if (description !== undefined) group.description = description.trim();

    await group.save();

    await group.populate("owner", "userName email avatar");
    await group.populate("members.userId", "userName email avatar");

    res.status(200).json({
      success: true,
      message: "Group updated successfully",
      group,
    });
  } catch (error) {
    console.error("Error updating group:", error);
    res.status(500).json({
      success: false,
      message: "Server error",
      error: error.message,
    });
  }
};

// ----- XÓA NHÓM -----
export const deleteGroup = async (req, res) => {
  try {
    const { groupId } = req.params;
    const userId = req.user._id;

    // Lấy thông tin nhóm
    const group = await groupModel.findById(groupId);

    if (!group) {
      return res.status(404).json({
        success: false,
        message: "Group not found",
      });
    }

    // Kiểm tra quyền owner
    if (group.owner.toString() !== userId.toString()) {
      return res.status(403).json({
        success: false,
        message: "Only group owner can delete the group",
      });
    }

    await groupTaskModel.deleteMany({ groupId: groupId });
    await groupModel.findByIdAndDelete(groupId);

    res.status(200).json({
      success: true,
      message: "Group and all related tasks deleted successfully",
    });
  } catch (error) {
    console.error("Error deleting group:", error);
    res.status(500).json({
      success: false,
      message: "Server error",
      error: error.message,
    });
  }
};

// ----- MỜI THÀNH VIÊN VÀO NHÓM -----
export const inviteMember = async (req, res) => {
  try {
    const { groupId } = req.params;
    const { email } = req.body;
    const userId = req.user._id;

    // Kiểm tra email có được gửi lên không
    if (!email || !email.trim()) {
      return res.status(400).json({
        success: false,
        message: "Email is required",
      });
    }

    // Lấy thông tin nhóm + owner
    const group = await groupModel
      .findById(groupId)
      .populate("owner", "userName email avatar");

    if (!group) {
      return res.status(404).json({
        success: false,
        message: "Group not found",
      });
    }

    // Chỉ owner mới có quyền mời
    if (group.owner._id.toString() !== userId.toString()) {
      return res.status(403).json({
        success: false,
        message: "Only group owner can invite members",
      });
    }

    // Tìm user theo email
    const invitedUser = await userModel.findOne({ email: email.trim() });

    if (!invitedUser) {
      return res.status(404).json({
        success: false,
        message: "User with this email does not exist",
      });
    }

    // Kiểm tra user đã là thành viên chưa
    const isAlreadyMember = group.Members.some(
      (Member) => Member.userId.toString() === invitedUser._id.toString()
    );

    if (isAlreadyMember) {
      return res.status(400).json({
        success: false,
        message: "User is already a member of this group",
      });
    }

    // Kiểm tra có lời mời đang chờ không
    const existingInvitation = group.invitations.find(
      (inv) => inv.email === email.trim() && inv.status === "Pending"
    );

    if (existingInvitation) {
      return res.status(400).json({
        success: false,
        message: "Invitation already sent to this email",
      });
    }

    // Tạo token duy nhất để join nhóm
    const token = crypto.randomBytes(32).toString("hex");
    const expiresAt = new Date(Date.now() + 1 * 24 * 60 * 60 * 1000); // Hết hạn 1 ngày

    // Thêm lời mời vào DB
    group.invitations.push({
      email: email.trim(),
      token,
      status: "Pending",
      invitedAt: new Date(),
      expiresAt,
    });

    await group.save();

    // Tạo link mời để gửi qua email
    const inviteLink = `${process.env.FRONTEND_URL}/join-group/${token}`;

    // Gửi email mời tham gia nhóm
    await sendMailJoinGroup(
      email.trim(),
      group.name,
      inviteLink,
      group.owner.userName
    );

    res.status(200).json({
      success: true,
      message: "Invitation sent successfully",
    });
  } catch (error) {
    console.error("Error inviting member:", error);
    res.status(500).json({
      success: false,
      message: "Server error",
      error: error.message,
    });
  }
};

// ----- NHÓM CÓ THÀNH VIÊN MỚI VÀO -----
export const joinGroup = async (req, res) => {
  try {
    const { token } = req.params; // Token từ URL
    const userId = req.user._id;

    // Tìm nhóm có lời mời với token đang chờ
    const group = await groupModel.findOne({
      "invitations.token": token,
      "invitations.status": "Pending",
    });

    if (!group) {
      return res.status(404).json({
        success: false,
        message: "Invalid or expired invitation",
      });
    }

    // Lấy lời mời từ nhóm
    const invitation = group.invitations.find(
      (inv) => inv.token === token && inv.status === "Pending"
    );

    if (!invitation) {
      return res.status(404).json({
        success: false,
        message: "Invitation not found",
      });
    }

    // Kiểm tra token có hết hạn chưa
    if (new Date() > invitation.expiresAt) {
      invitation.status = "Expired";
      await group.save();
      return res.status(400).json({
        success: false,
        message: "Invitation has expired",
      });
    }

    // Kiểm tra email đăng nhập phải khớp email được mời
    const user = await userModel.findById(userId);

    // Kiểm tra đã là thành viên chưa
    if (user.email !== invitation.email) {
      return res.status(403).json({
        success: false,
        message: "This invitation was sent to a different email address",
      });
    }

    const isAlreadyMember = group.members.some(
      (Member) => Member.userId.toString() === userId.toString()
    );

    if (isAlreadyMember) {
      return res.status(400).json({
        success: false,
        message: "You are already a member of this group",
      });
    }

    // Thêm user vào members
    group.members.push({
      userId: userId,
      role: "Member",
      joinedAt: new Date(),
    });

    // Đánh dấu lời mời thành Accepted
    invitation.status = "Accepted";
    await group.save();

    // Populate thông tin đầy đủ
    await group.populate("owner", "userName email avatar");
    await group.populate("members.userId", "userName email avatar");

    res.status(200).json({
      success: true,
      message: "Successfully joined the group",
      group,
    });
  } catch (error) {
    console.error("Error joining group:", error);
    res.status(500).json({
      success: false,
      message: "Server error",
      error: error.message,
    });
  }
};

// ----- XÓA THÀNH VIÊN KHỎI NHÓM -----
export const removeMember = async (req, res) => {
  try {
    const { groupId, memberId } = req.params; // Lấy groupId + memberId từ URL
    const userId = req.user._id; // ID của user đang đăng nhập

    // Tìm nhóm
    const group = await groupModel.findById(groupId);

    if (!group) {
      return res.status(404).json({
        success: false,
        message: "Group not found",
      });
    }

    // Chỉ owner mới có quyền xóa
    if (group.owner.toString() !== userId.toString()) {
      return res.status(403).json({
        success: false,
        message: "Only group owner can remove members",
      });
    }

    // owner không thể xóa chính mình
    if (memberId === userId.toString()) {
      return res.status(400).json({
        success: false,
        message: "owner cannot remove themselves",
      });
    }

    // Tìm index của Member trong mảng Members
    const MemberIndex = group.members.findIndex(
      (Member) => Member.userId.toString() === memberId
    );

    if (MemberIndex === -1) {
      return res.status(404).json({
        success: false,
        message: "Member not found in this group",
      });
    }

    group.members.splice(MemberIndex, 1);
    await group.save();

    // Xóa các task mà thành viên này được giao trong nhóm
    await groupTaskModel.deleteMany({
      groupId: groupId,
      assignedTo: memberId,
    });

    res.status(200).json({
      success: true,
      message: "Member removed successfully",
    });
  } catch (error) {
    console.error("Error removing member:", error);
    res.status(500).json({
      success: false,
      message: "Server error",
      error: error.message,
    });
  }
};

// ----- THÀNH VIÊN TỰ RỜI NHÓM -----
export const leaveGroup = async (req, res) => {
  try {
    const { groupId } = req.params; // Lấy groupId từ URL
    const userId = req.user._id; // ID user đang đăng nhập

    // Tìm nhóm
    const group = await groupModel.findById(groupId);

    if (!group) {
      return res.status(404).json({
        success: false,
        message: "Group not found",
      });
    }

    // owner không được rời nhóm
    if (group.owner.toString() === userId.toString()) {
      return res.status(400).json({
        success: false,
        message:
          "Owner cannot leave the group. Please delete the group or transfer ownership first.",
      });
    }

    // Tìm index của Member trong mảng Members
    const MemberIndex = group.members.findIndex(
      (Member) => Member.userId.toString() === userId.toString()
    );

    if (MemberIndex === -1) {
      return res.status(404).json({
        success: false,
        message: "You are not a member of this group",
      });
    }

    // Xóa thành viên khỏi mảng Members
    group.members.splice(MemberIndex, 1);
    await group.save();

    // Xóa các task của user trong nhóm
    await groupTaskModel.deleteMany({
      groupId: groupId,
      assignedTo: userId,
    });

    res.status(200).json({
      success: true,
      message: "Successfully left the group",
    });
  } catch (error) {
    console.error("Error leaving group:", error);
    res.status(500).json({
      success: false,
      message: "Server error",
      error: error.message,
    });
  }
};
